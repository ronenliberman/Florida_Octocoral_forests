---
title: "Modelling_cover_data"
author: "Ronen liberman"
date: "2024-06-13"
output: 
  html_document:
    theme: cerulean
    toc: yes
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r install_libraries, eval=FALSE}
# Install necessary libraries
install.packages(c("rmdformats", "prettydoc", "hrbrthemes", "tint", "tufte"))
```

```{r initiate-environment, message=FALSE, warning=FALSE, include=FALSE}
library(tidyverse)
library("knitr")
library("gridExtra")
library("ggpubr")
library("data.table")
library(lme4)
library(glmmTMB)
library(bbmle)
library(performance)
library(ggplot2)
library(plotrix)
library(gridExtra)
library(car)
library(emmeans)
library(DHARMa)
library(RRPP)
#library(MuMIn)
library(MASS)
library(lattice)
library(rmdformats)
library(prettydoc)
library(hrbrthemes)
library(tint)
library(tufte)
```


Data prep. 
I am using the "Cover_All.csv" dataset. The sites are similar to the list of sites that were used to model density and biomass data. 
A code chunk of data preparation should be added here later 

```{r}
#Cover_dat <- read.csv("~/Postdocing_NSU/Octocoral forests/Manuscript/scripts/Cover_All.csv")
Cover_dat <- read.csv("C:\\Users\\nj350\\OneDrive - Nova Southeastern University\\Documents\\Publications\\Papers\\In Progress\\Liberman et al - Gorgs\\Cover_All.csv")
# Convert Depth to numeric
Cover_dat$Depth <- as.numeric(as.character(Cover_dat$Depth))
Cover_dat <- Cover_dat[,-1] #remove extra column

# Clean the Habitat column by trimming leading and trailing spaces
library(stringr)
Cover_dat <- Cover_dat %>%
  mutate(Habitat = str_trim(Habitat))
unique(Cover_dat$Habitat)

# Convert SiteID and StationID to factors and add depth groups
Cover_Depth <- Cover_dat %>%
  mutate(SiteID = as.factor(SiteID),
         StationID = as.factor(StationID),
         Habitat = as.factor(Habitat),
         Subregion = as.factor(Subregion),
         fYear  = as.factor(Year))%>% 
  mutate(Depth_group = case_when(
    Depth < 20 ~ "Shallow",
    Depth >= 20 & Depth < 45 ~ "Mid", 
    Depth >= 45 ~ "Deep"
  ))

glimpse(Cover_Depth)
unique(Cover_Depth$Subregion)
unique(Cover_Depth$SiteName)
length(unique(Cover_Depth$SiteName))
unique(Cover_Depth$Habitat)

Cover_Depth$Reg.Hab <- paste(Cover_Depth$ProjectRegion, "_", Cover_Depth$Habitat)
Cover_Depth$Reg.Hab <- as.factor(Cover_Depth$Reg.Hab)
unique(Cover_Depth$Reg.Hab)

Cover_Depth$Reg.Hab <- factor(Cover_Depth$Reg.Hab, levels = c("NPSDT _ P", "NPSDT _ OD", "FKNMS _ P", "FKNMS _ OS", "FKNMS _ OD",
                                                              "SECREMP _ Nearshore", "SECREMP _ Inner", "SECREMP _ Middle", 
                                                              "SECREMP _ Outer"))
```
Modeling 
Here I follow the same model structure that has been developed for the density and biomass data. The difference here is that I run models using 'family = binomial', and the model takes into account the number of points per image as weights. 

```{r message=TRUE, warning=FALSE}
cover_full_model = glmmTMB(OCTO ~ fYear * Subregion+Depth+Habitat+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)


cover_depth <- glmmTMB(OCTO ~ fYear * Depth+ (1|SiteID/StationID),
                          control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),
                       weights = points,family = binomial,data = Cover_Depth)

cover_depth2 <- glmmTMB(OCTO ~ fYear * Depth_group + (1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_Subregion <- glmmTMB(OCTO ~ fYear * Subregion+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_Subregion2 <- glmmTMB(OCTO ~ fYear + Subregion+Depth+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_Subregion3 <- glmmTMB(OCTO ~ fYear * Subregion+Depth_group+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_Subregion4 <- glmmTMB(OCTO ~ fYear + Subregion+Habitat+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_Subregion4 <- glmmTMB(OCTO ~ fYear + Subregion+Habitat+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_ProjectRegion <- glmmTMB(OCTO ~ fYear * ProjectRegion +(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_ProjectRegion2 <-  glmmTMB(OCTO ~ fYear + ProjectRegion +Depth+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)


cover_ProjectRegion3 <-  glmmTMB(OCTO ~ fYear * ProjectRegion+Habitat+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_Year <- glmmTMB(OCTO ~ fYear * Depth+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)


cover_habitat <- glmmTMB(OCTO ~ fYear * Habitat+(1|SiteID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_habitat2 <- glmmTMB(OCTO ~ fYear + Habitat+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_habitat3 <- glmmTMB(OCTO ~ fYear * Habitat+Depth+(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_habitat4 <- glmmTMB(OCTO ~ fYear + Habitat+Depth_group +(1|SiteID/StationID), control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

cover_null <- glmmTMB(OCTO ~  + 1, control = glmmTMBControl(optCtrl=list(iter.max=1e3,eval.max=1e3)),weights = points,
                                                    family = binomial, 
                                                    data = Cover_Depth)

#add optional model that looks at habitat within region - this was where most variation was in our previous cover models

cover_reg.hab <- glmmTMB(OCTO ~ fYear * Reg.Hab+(1|SiteID/StationID),
                                 family = binomial, weights = points, 
                                 data = Cover_Depth)

cover_reg.hab2 <- glmmTMB(OCTO ~ fYear * Reg.Hab+Depth + (1|SiteID/StationID),
                                 family = binomial, weights = points, 
                                 data = Cover_Depth)

```

#Model selection
```{r echo=FALSE}
AICtab(cover_full_model,
       cover_depth,cover_depth2,
       cover_Subregion,cover_Subregion2,cover_Subregion3,cover_Subregion4,
       cover_ProjectRegion,cover_ProjectRegion2,cover_ProjectRegion3,
       cover_Year,
       cover_habitat,cover_habitat2,cover_habitat3,cover_habitat4,
       cover_null, cover_reg.hab, cover_reg.hab2)

#BIC(cover_full_model,
 #      cover_depth,cover_depth2,
#       cover_Subregion,cover_Subregion2,cover_Subregion3,cover_Subregion4,
#       cover_ProjectRegion,cover_ProjectRegion2,cover_ProjectRegion3,
#       cover_Year,
#       cover_habitat,cover_habitat2,cover_habitat3,cover_habitat4,
#       cover_null)
```

Model Summary 
```{r echo=FALSE}

summary(cover_reg.hab) #estimates and SE look fine, decent bit of variance between sites and stations although not too high in the conditional R2

#FYI - I ran model validation with the previous best models full model (validation suggested problems) and year x subregion (estimates from marginal means suggested problems - estimates seemed to be the opposite of what we'd expect suggesting the model is not very good!)

```

Validation of the best model - cover_reg.hab using the DHarma package
```{r message=FALSE, warning=FALSE}
cover_simulationOutput <- simulateResiduals(cover_reg.hab , n = 1000, plot = TRUE,quantreg = T) 
# Dispersion is OK, model has issues with outlier, uniformity and homogeneity

testOutliers(cover_simulationOutput, type = "bootstrap") #OUTLIeR test significant: This can be a problem!

plotResiduals(cover_simulationOutput, Cover_Depth$Reg.Hab) #DRTO P and SECREMP inner the issues
plotResiduals(cover_simulationOutput, Cover_Depth$fYear) #year is fine

res <- recalculateResiduals(cover_simulationOutput, group = Cover_Depth$Year)
testTemporalAutocorrelation(simulationOutput = res, time = unique(Cover_Depth$Year)) #no problems

res2 <- recalculateResiduals(cover_simulationOutput, group = Cover_Depth$SiteID)
plot(res2) #looks fine with recalculated residuals suggesting we are appropriately accounting for the overdispersion with the site level random effect. Continue with this model

```
### Plot out the data to visually compare with GLMM results and check linearity

```{r}
Cover_Depth$Reg.Hab <- factor(Cover_Depth$Reg.Hab, levels = c("NPSDT _ P", "NPSDT _ OD", "FKNMS _ P", "FKNMS _ OS", "FKNMS _ OD",
                                                              "SECREMP _ Nearshore", "SECREMP _ Inner", "SECREMP _ Middle", 
                                                              "SECREMP _ Outer"))

Cover_Depth %>% group_by(Reg.Hab) %>%
  summarise(Mean = mean(OCTO))

ggplot(Cover_Depth, aes(x = Year, y = OCTO))+
  geom_point()+
  geom_smooth()+
  facet_wrap(~Reg.Hab)

#looks reasonably linear - there are generally equal numbers of sites above and below the mean, temporal pattern isn't too wiggly

#I checked out the three way interaction hab x sub x year but that's not as good, same with year x reg.hab

```

###Post Hoc
```{r}

r2(cover_reg.hab) #conditional 0.96, marginal = 0.48
#not explaining that much, but not much can be done without modelling site level differences explicitly (may be that sites are changing differently, we haven't fitted this in the GLMM), but it's really another question as our focus initially are understanding the broadscale patterns of octocorals. 

#note esimates are on the logit scale - positive means the first of the 2 options is more likely (i.e., has higher cover), negative means less likely to happen (i.e., there been an increase in cover from x to y)

#post hoc of temporal changes within habitats
emm.year <- emmeans(cover_reg.hab, ~fYear|Reg.Hab)
pairs(emm.year)
contrast(emm.year)
plot(emm.year)+
      theme_bw()+
  theme(legend.position = c(0.92, 0.2),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.1),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, hjust = 1, colour = "black"),  
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.x = element_text(size = 14), 
        axis.line = element_line(size = 0.5), 
        axis.ticks = element_blank(),
        plot.margin = ggplot2::margin(12,6),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.text = element_text(size = 5))

#opposite post hoc - compare habitats within years

emm.hab <- emmeans(cover_reg.hab, ~Reg.Hab|fYear)
pairs(emm.hab)
plot(emm.hab)
      theme_bw()+
  theme(legend.position = c(0.92, 0.2),
        legend.title = element_blank(),
        legend.text = element_text(size = 12),
        plot.title = element_text(hjust = 0.1),
        axis.title.y = element_text(size = 14),
        axis.text.y = element_text(size = 12, hjust = 1, colour = "black"),  
        axis.text.x = element_text(size = 12, colour = "black"), 
        axis.title.x = element_text(size = 14), 
        axis.line = element_line(size = 0.5), 
        axis.ticks = element_blank(),
        plot.margin = ggplot2::margin(12,6),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank(),
        strip.text = element_text(size = 5))

#model estimates, comparisons and contrasts look reasonable based upon the data. I suggest using this model unless we want to model branching/GVEN and encrusting octocoral cover separately

```



